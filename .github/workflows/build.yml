name: Application Build & Deployment

on:
  push:
    branches: [ "1.1" ]

permissions:
  contents: write

jobs:
  linux-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install glfw
      run: sudo apt install -y libglfw3-dev

    - name: build
      run: |
        make build

    - name: Create tarball
      uses: a7ul/tar-action@v1.1.0
      with:
        command: c
        cwd: ./build/linux
        files: |
          ./*
        outPath: application-linux.tar.gz

    - uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: ./build/application-linux.tar.gz

  windows-build_x86:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - uses: msys2/setup-msys2@v2
      with:
        msystem: UCRT64
        update: true
        install: >-
          make
          gcc

    - shell: msys2 {0}
      run: |
        make build BITWISE_GLFW=True
    
    - uses: montudor/action-zip@v1
      with:
        args: zip -qq -r ./build/application-windows.zip ./build/windows
    
    - uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: ./build/application-windows.zip

  
  deployement:
    runs-on: ubuntu-latest
    needs: [ windows-build_x86, linux-build ]
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: get linux tarball
        uses: actions/download-artifact@v4
        with:
          name: linux-build
          path: ./application-linux.tar.gz

      - name: linux-build
        uses: actions/download-artifact@v4
        with:
          name: windows-build
          path: ./application-windows.zip

      - name: create release body
        run: echo "# test release" > body.md
      
      - uses: ncipollo/release-action@v1
        with:
          artifacts: "release.tar.gz,foo/*.txt"
          bodyFile: "body.md"